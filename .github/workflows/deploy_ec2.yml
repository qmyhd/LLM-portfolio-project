name: Deploy to EC2

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'requirements.txt'
      - 'ecosystem.config.js'
  workflow_dispatch:
    inputs:
      restart_bot:
        description: 'Restart Discord bot after deploy'
        required: false
        default: true
        type: boolean

# Ensure only one deployment runs at a time
concurrency:
  group: deploy-ec2
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Get EC2 instance info
        id: ec2
        run: |
          # Get instance public DNS from secrets or describe instance
          if [ -n "${{ secrets.EC2_PUBLIC_DNS }}" ]; then
            echo "host=${{ secrets.EC2_PUBLIC_DNS }}" >> $GITHUB_OUTPUT
          else
            host=$(aws ec2 describe-instances \
              --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
              --query 'Reservations[0].Instances[0].PublicDnsName' \
              --output text)
            echo "host=$host" >> $GITHUB_OUTPUT
          fi

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          ssh-keyscan -H ${{ steps.ec2.outputs.host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ steps.ec2.outputs.host }}
          EC2_USER: ${{ secrets.EC2_USER || 'ubuntu' }}
          PROJECT_DIR: ${{ secrets.EC2_PROJECT_DIR || '/home/ubuntu/LLM-portfolio-project' }}
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${EC2_USER}@${EC2_HOST} << 'DEPLOY_SCRIPT'
          set -e
          
          echo "=== Deployment started at $(date) ==="
          
          # Navigate to project directory
          cd ${PROJECT_DIR:-/home/ubuntu/LLM-portfolio-project}
          
          # Pull latest code
          echo "ðŸ“¥ Pulling latest code..."
          git fetch origin main
          git reset --hard origin/main
          
          # Activate virtual environment
          echo "ðŸ”§ Activating virtual environment..."
          source .venv/bin/activate
          
          # Update dependencies
          echo "ðŸ“¦ Installing dependencies..."
          pip install -r requirements.txt --quiet
          
          # Verify core imports
          echo "âœ… Verifying imports..."
          python -c "from src.db import execute_sql; from src.config import settings; print('Core imports OK')"
          
          echo "=== Code deployment complete ==="
          DEPLOY_SCRIPT

      - name: Restart Discord Bot
        if: ${{ github.event.inputs.restart_bot != 'false' }}
        env:
          EC2_HOST: ${{ steps.ec2.outputs.host }}
          EC2_USER: ${{ secrets.EC2_USER || 'ubuntu' }}
          PROJECT_DIR: ${{ secrets.EC2_PROJECT_DIR || '/home/ubuntu/LLM-portfolio-project' }}
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${EC2_USER}@${EC2_HOST} << 'RESTART_SCRIPT'
          set -e
          
          cd ${PROJECT_DIR:-/home/ubuntu/LLM-portfolio-project}
          
          # Check if PM2 is running the bot
          if pm2 list | grep -q "discord-bot"; then
            echo "ðŸ”„ Restarting Discord bot via PM2..."
            pm2 restart discord-bot
            
            # Wait and check status
            sleep 5
            pm2 status discord-bot
            
            # Show recent logs
            echo "ðŸ“‹ Recent logs:"
            pm2 logs discord-bot --lines 10 --nostream
          else
            echo "âš ï¸  Discord bot not found in PM2. Starting..."
            pm2 start ecosystem.config.js
            pm2 save
          fi
          
          echo "=== Bot restart complete ==="
          RESTART_SCRIPT

      - name: Health check
        env:
          EC2_HOST: ${{ steps.ec2.outputs.host }}
          EC2_USER: ${{ secrets.EC2_USER || 'ubuntu' }}
          PROJECT_DIR: ${{ secrets.EC2_PROJECT_DIR || '/home/ubuntu/LLM-portfolio-project' }}
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${EC2_USER}@${EC2_HOST} << 'HEALTH_SCRIPT'
          set -e
          
          cd ${PROJECT_DIR:-/home/ubuntu/LLM-portfolio-project}
          source .venv/bin/activate
          
          echo "ðŸ¥ Running health check..."
          
          # Check PM2 status
          pm2 status
          
          # Quick DB connectivity check (if secrets are loaded)
          python -c "
          import os
          if os.environ.get('USE_AWS_SECRETS') == '1':
              from src.aws_secrets import load_secrets_to_env
              load_secrets_to_env()
          from src.db import healthcheck
          if healthcheck():
              print('âœ… Database: OK')
          else:
              print('âš ï¸  Database: Connection issue')
          " 2>/dev/null || echo "â„¹ï¸  Skipping DB check (secrets not loaded in this shell)"
          
          echo "=== Health check complete ==="
          HEALTH_SCRIPT

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/ec2_key.pem

  notify:
    name: Notify on Failure
    needs: deploy
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Create failure summary
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment to EC2 failed. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
