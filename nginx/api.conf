# Nginx reverse proxy configuration for LLM Portfolio Journal API
# 
# Setup Instructions:
# 1. Copy to /etc/nginx/conf.d/api.conf
# 2. Run certbot for SSL: sudo certbot --nginx -d api.llmportfolio.app
# 3. Test config: sudo nginx -t
# 4. Reload: sudo systemctl reload nginx
#
# After changes:
#   sudo nginx -t && sudo systemctl reload nginx
#   ./scripts/doctor_ec2.sh
#   # Confirm wp-* probes no longer reach FastAPI:
#   curl -s -o /dev/null -w "%{http_code}" https://api.llmportfolio.app/wp-admin  # expect 444/empty

# Rate limiting zone (10MB shared memory, 10 requests/second per IP)
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# Upstream FastAPI server (localhost only)
upstream fastapi_backend {
    server 127.0.0.1:8000;
    keepalive 32;
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name api.llmportfolio.app;
    
    # Allow certbot ACME challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    # Redirect all other traffic to HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.llmportfolio.app;

    # SSL configuration (managed by Certbot)
    ssl_certificate /etc/letsencrypt/live/api.llmportfolio.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.llmportfolio.app/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Logging
    access_log /var/log/nginx/api_access.log;
    error_log /var/log/nginx/api_error.log;

    # Client body size limit (for file uploads if needed)
    client_max_body_size 10M;

    # Block non-standard methods early (scanner noise)
    if ($request_method !~ ^(GET|POST|PUT|DELETE|OPTIONS)$) { return 444; }

    # Drop noisy scanner hits on root and common probe targets
    location = /           { access_log off; return 444; }
    location = /favicon.ico { access_log off; return 444; }
    location = /robots.txt  { access_log off; return 444; }

    # Hide OpenAPI docs in production
    location ~* ^/(docs|redoc|openapi\.json)$ { return 404; }

    # Block common scanner/exploit probe paths (never forwarded to FastAPI)
    location ~* ^/(wp-admin|wp-login\.php|wp-content|wp-includes) {
        access_log off;
        return 444;
    }
    location ~* ^/(\.env|config\.|secrets\.|actuator|phpinfo\.php|cgi-bin|phpmyadmin|xmlrpc\.php) {
        access_log off;
        return 444;
    }

    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Health check endpoint (no rate limiting)
    location /health {
        proxy_pass http://fastapi_backend/health;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Webhook endpoint (no rate limiting, signature verification is sufficient)
    location /webhook/ {
        proxy_pass http://fastapi_backend/webhook/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Pass through SnapTrade signature header
        proxy_pass_request_headers on;
    }

    # API endpoints (with rate limiting)
    location / {
        # Rate limiting: 10 requests/second, burst of 20
        limit_req zone=api_limit burst=20 nodelay;
        limit_req_status 429;

        proxy_pass http://fastapi_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Pass Authorization header
        proxy_pass_request_headers on;

        # CORS headers (FastAPI also handles this, but Nginx can add as backup)
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Request-ID" always;
        add_header Access-Control-Allow-Credentials "true" always;

        # Handle preflight OPTIONS requests
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin $http_origin;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Request-ID";
            add_header Access-Control-Allow-Credentials "true";
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }
}
