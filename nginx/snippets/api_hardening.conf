# api_hardening.conf — Paste inside the HTTPS server{} block, ABOVE the main location / block.
#
# This is a SNIPPET, not a standalone config. It adds scanner blocking,
# probe silencing, and docs hiding to an existing Nginx HTTPS server.

# ── Block non-standard HTTP methods (scanner noise) ──────────────────
if ($request_method !~ ^(GET|POST|PUT|DELETE|OPTIONS)$) { return 444; }

# ── Drop root and common probe targets silently ──────────────────────
location = / { access_log off; return 444; }
location = /favicon.ico { access_log off; return 444; }
location = /robots.txt { access_log off; return 444; }

# ── Hide OpenAPI docs in production ──────────────────────────────────
location ~* ^/(docs|redoc|openapi\.json)$ { return 404; }

# ── Block WordPress / CMS scanner paths ──────────────────────────────
location ~* ^/(wp-admin|wp-login\.php|wp-content|wp-includes|wp-config) { access_log off; return 444; }

# ── Block common exploit/config probe paths ──────────────────────────
location ~* ^/(\.env|config\.|secrets\.|actuator|phpinfo\.php|cgi-bin|phpmyadmin|xmlrpc\.php) { access_log off; return 444; }

# ── Health check (no rate limiting) ──────────────────────────────────
location = /health {
    access_log off;
    proxy_pass http://fastapi_backend/health;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
